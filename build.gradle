plugins {
    id 'java'
    id 'application'
    id 'com.google.cloud.tools.jib' version '3.4.2'
    id 'com.google.protobuf' version '0.9.4'
}

group = 'ai.pipestream'
version = '0.0.1-SNAPSHOT'

repositories {
    mavenLocal()
    mavenCentral()
}

configurations.all {
    resolutionStrategy {
        force 'com.google.protobuf:protobuf-java:3.25.5'
        force 'com.google.protobuf:protobuf-java-util:3.25.5'
    }
}

dependencies {
    implementation 'org.wiremock:wiremock:3.13.2'
    implementation('org.wiremock:wiremock-grpc-extension:0.11.0') {
        exclude group: 'com.google.protobuf', module: 'protobuf-java'
    }
    // REMOVED: implementation 'ai.pipestream:grpc-google-descriptor:0.2.12-SNAPSHOT'
    
    implementation 'org.slf4j:slf4j-simple:2.0.13'
    
    implementation 'com.google.protobuf:protobuf-java:3.25.5'
    implementation 'com.google.protobuf:protobuf-java-util:3.25.5'

    // gRPC runtime dependencies for the custom server
    implementation 'io.grpc:grpc-netty:1.59.0'
    implementation 'io.grpc:grpc-protobuf:1.59.0'
    implementation 'io.grpc:grpc-stub:1.59.0'
    compileOnly 'javax.annotation:javax.annotation-api:1.3.2'

    // Depend on the protos to extract them
    protobuf 'ai.pipestream:pipestream-protos:0.2.12-SNAPSHOT'
    // We need standard imports as well
    protobuf 'com.google.api.grpc:proto-google-common-protos:2.29.0' 
}

// ... java config ...

protobuf {
    protoc {
        // Use an older protoc that matches our forced runtime
        artifact = 'com.google.protobuf:protoc:3.25.5'
    }
    plugins {
        grpc {
            artifact = 'io.grpc:protoc-gen-grpc-java:1.59.0'
        }
    }
    generateProtoTasks {
        all().each { task ->
            task.generateDescriptorSet = true
            task.descriptorSetOptions.includeImports = true
            // Output the descriptor to the META-INF/grpc directory in the build output
            task.descriptorSetOptions.path = "${buildDir}/resources/main/META-INF/grpc/services.dsc"
            
            task.plugins {
                grpc {}
            }
        }
    }
}

// Ensure the directory exists
tasks.named('generateProto').configure {
    doFirst {
        mkdir "${buildDir}/resources/main/META-INF/grpc"
    }
}

application {
    mainClass = 'ai.pipestream.wiremock.server.Main'
}

jib {
    to {
        image = 'ai-pipestream/pipestream-wiremock-server'
        tags = ['latest', version]
    }
    container {
        mainClass = 'ai.pipestream.wiremock.server.Main'
        ports = ['8080', '50051'] // HTTP and gRPC ports
        jvmFlags = ['-Djava.awt.headless=true']
    }
}
